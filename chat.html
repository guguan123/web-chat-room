<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>聊天室</title>
	<script src="https://guguan.us.kg/tracking.js" async></script>
	<style>
		body {
			margin: 0;
			display: flex;
			flex-direction: column;
			height: 100vh;
			padding: 20px;
			box-sizing: border-box;
		}

		h1 {
			margin-top: 0;
			margin-bottom: 20px;
		}

		#username-input {
			margin-bottom: 10px;
		}

		#chat-window {
			border: 1px solid #ccc;
			padding: 10px;
			flex-grow: 1;
			overflow-y: scroll;
			margin-bottom: 10px;
			background-color: #fff;
		}

		.message {
			margin-bottom: 8px;
		}

		.timestamp {
			font-size: 0.8em;
			color: #888;
			margin-left: 10px;
		}

		.input-form {
			display: flex;
			width: 100%;
		}

		.input-form input[type="text"] {
			flex-grow: 1;
			padding: 8px;
			border: 1px solid #ccc;
			margin-right: 10px;
		}

		.input-form button {
			padding: 8px 15px;
			background-color: #007bff;
			color: white;
			border: none;
			cursor: pointer;
		}
	</style>
</head>
<body>
	<h1>聊天室</h1>

	<div id="username-input">
		<label for="username">你的名字:</label>
		<input type="text" id="username" placeholder="输入你的名字" value="anonymous">
	</div>

	<div id="chat-window">
	</div>

	<div class="input-form">
		<input type="text" id="message-input" placeholder="输入消息...">
		<button onclick="sendMessage()">发送</button>
	</div>

<script>
		const chatWindow = document.getElementById('chat-window');
		const messageInput = document.getElementById('message-input');
		const usernameInput = document.getElementById('username');
		const sendButton = document.querySelector('.input-form button');

		// 存储当前聊天窗口中已显示消息的ID，用于避免重复添加
		const displayedMessageIds = new Set();

		setInterval(fetchMessages, 5000);
		window.onload = fetchMessages;

		async function fetchMessages() {
			try {
				const response = await fetch('./cgi-bin/get_messages.sh');
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const messages = await response.json();
				let shouldScroll = false; // 标记是否需要滚动

				// 检查当前滚动位置，如果用户在底部，则新消息进来后需要滚动
				if (chatWindow.scrollHeight - chatWindow.scrollTop <= chatWindow.clientHeight + 50) { // 加一点容错值
					shouldScroll = true;
				}

				messages.forEach(msg => {
					// 只有当消息包含必需字段且其ID尚未显示时才添加
					if (msg.id && msg.timestamp && msg.ip && msg.username && msg.message && !displayedMessageIds.has(msg.id)) {
						const messageElement = document.createElement('div');
						messageElement.classList.add('message');
						messageElement.id = `msg-${msg.id}`; // 给消息元素设置ID，方便查找和管理
						messageElement.innerHTML = `<strong>${escapeHtml(msg.username)}</strong>: ${escapeHtml(msg.message)} <span class="timestamp">${msg.timestamp}</span>`;
						chatWindow.appendChild(messageElement);
						displayedMessageIds.add(msg.id); // 将新消息ID添加到Set中
					}
				});

				if (shouldScroll) {
					chatWindow.scrollTop = chatWindow.scrollHeight; // 滚动到底部
				}

				// 可选：如果消息数量超过MAX_MESSAGES，前端也应该清理旧消息DOM
				// 但由于后端已经处理了消息数量，这里通常不是必须的，除非你想严格控制前端DOM数量。
				// 如果需要，可以比较 displayedMessageIds.size 和 messages.length，移除多余的旧DOM元素。

			} catch (error) {
				console.error('获取消息失败:', error);
			}
		}

		async function sendMessage() {
			let message = messageInput.value.trim();
			const username = usernameInput.value.trim() || 'anonymous';

			const MAX_FRONTEND_MESSAGE_LENGTH = 512;

			if (message === '') {
				return;
			}

			messageInput.disabled = true;
			sendButton.disabled = true;
			sendButton.textContent = '发送中...';

			const messagesToSend = [];
			while (message.length > 0) {
				messagesToSend.push(message.substring(0, MAX_FRONTEND_MESSAGE_LENGTH));
				message = message.substring(MAX_FRONTEND_MESSAGE_LENGTH);
			}

			try {
				for (const part of messagesToSend) {
					const formData = new URLSearchParams();
					formData.append('username', username);
					formData.append('message', part); // Send each part

					const response = await fetch('./cgi-bin/post_message.sh', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: formData.toString()
					});

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					const result = await response.text();
					console.log('消息发送结果:', result);
				}

				messageInput.value = '';
				fetchMessages(); // Refresh messages after all parts are sent
			} catch (error) {
				console.error('发送消息失败:', error);
			} finally {
				messageInput.disabled = false;
				sendButton.disabled = false;
				sendButton.textContent = '发送';
				messageInput.focus();
			}
		}

		function escapeHtml(str) {
			const div = document.createElement('div');
			div.appendChild(document.createTextNode(str));
			return div.innerHTML;
		}

		messageInput.addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				sendMessage();
			}
		});
	</script>
</body>
</html>
