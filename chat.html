<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>聊天室</title>
	<script src="https://guguan.us.kg/tracking.js" async></script>
	<link href="https://guguan.us.kg/dark.css" rel="stylesheet" media="(prefers-color-scheme: dark)">
	<style>
		body {
			margin: 0;
			display: flex;
			flex-direction: column;
			height: 100vh;
			padding: 20px;
			box-sizing: border-box;
		}

		h1 {
			margin-top: 0;
			margin-bottom: 20px;
		}

		#notification-setting {
			margin-bottom: 10px;
		}

		#chat-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		#username-display {
			font-weight: bold;
		}

		#chat-window {
			border: 1px solid #ccc;
			padding: 10px;
			flex-grow: 1;
			overflow-y: scroll;
			margin-bottom: 10px;
		}

		.message {
			margin-bottom: 8px;
		}

		.timestamp {
			font-size: 0.8em;
			color: #888;
			margin-left: 10px;
		}

		.input-form {
			display: flex;
			width: 100%;
		}

		.input-form input[type="text"] {
			flex-grow: 1;
			padding: 8px;
			border: 1px solid #ccc;
			margin-right: 10px;
		}

		.input-form button {
			padding: 8px 15px;
			background-color: #007bff;
			color: white;
			border: none;
			cursor: pointer;
		}
	</style>
</head>
<body>
	<div id="chat-header">
		<h1>聊天室</h1>
		<div>
			<span id="username-display"></span>
			<a href="user_management.html">管理账户</a>
		</div>
		<div id="notification-setting">
			<input type="checkbox" id="enable-notifications">
			<label for="enable-notifications">开启桌面通知 (仅在后台生效)</label>
		</div>
	</div>

	<div id="chat-window"></div>

	<div class="input-form">
		<input type="text" id="message-input" placeholder="输入消息...">
		<button onclick="sendMessage()">发送</button>
	</div>

	<script>
		const chatWindow = document.getElementById('chat-window');
		const messageInput = document.getElementById('message-input');
		const sendButton = document.querySelector('.input-form button');
		const enableNotificationsCheckbox = document.getElementById('enable-notifications');
		const usernameDisplay = document.getElementById('username-display');
		const MAX_FRONTEND_MESSAGE_LENGTH = 512;

		// 存储当前聊天窗口中已显示消息的ID，用于避免重复添加
		const displayedMessageIds = new Set();
		let currentNotifications = []; // 存储当前活动的通知实例，以便在需要时关闭
		let isInitialLoad = true; // 标记是否是首次加载

		// 页面加载时尝试从 localStorage 读取通知设置
		const savedNotificationSetting = localStorage.getItem('enableNotifications');
		if (savedNotificationSetting === 'true') {
			enableNotificationsCheckbox.checked = true;
		}
		
		function getCookie(name) {
			const nameEQ = name + "=";
			const ca = document.cookie.split(';');
			for(let i = 0; i < ca.length; i++) {
				let c = ca[i];
				while (c.charAt(0) === ' ') c = c.substring(1, c.length);
				if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
			}
			return null;
		}

		// 页面加载时尝试从 Cookie 读取用户名
		function updateUsernameDisplay() {
			const username = getCookie('username') || 'anonymous';
			usernameDisplay.textContent = `当前用户: ${username}`;
		}

		// 页面加载后立即触发一次 fetchMessages，但避免通知
		window.onload = async () => {
			updateUsernameDisplay();
			await fetchMessages(); // 首次加载，先获取消息
			setInterval(fetchMessages, 5000); // 然后启动定时刷新
		};

		async function fetchMessages() {
			try {
				const response = await fetch('./cgi-bin/chat_handler.cgi');
				const result = await response.json();
				
				if (!response.ok) {
					throw new Error(result.message || `HTTP error! status: ${response.status}`);
				}

				let shouldScroll = false; // 标记是否需要滚动
				let newMessages = []; // 存储新消息，用于通知

				// 检查当前滚动位置，如果用户在底部，则新消息进来后需要滚动
				if (chatWindow.scrollHeight - chatWindow.scrollTop <= chatWindow.clientHeight + 50) { // 加一点容错值
					shouldScroll = true;
				}
				
				const messages = result.data; // 从 data 字段中获取消息数组

				messages.forEach(msg => {
					// 只有当消息包含必需字段且其ID尚未显示时才添加
					if (msg.id && msg.timestamp && msg.ip && msg.username && msg.message && !displayedMessageIds.has(msg.id)) {
						const messageElement = document.createElement('div');
						messageElement.classList.add('message');
						messageElement.id = `msg-${msg.id}`; // 给消息元素设置ID，方便查找和管理

						// 将Unix epoch秒级时间戳转换为用户本地时间
						const date = new Date(msg.timestamp * 1000);
						const localTime = date.toLocaleString(); // 自动转换为用户本地时区格式

						messageElement.innerHTML = `<strong>${escapeHtml(msg.username)}</strong>: ${escapeHtml(msg.message)} <span class="timestamp">${localTime}</span>`;
						chatWindow.appendChild(messageElement);
						displayedMessageIds.add(msg.id); // 将新消息ID添加到Set中
						newMessages.push(msg); // 将新消息添加到数组中
					}
				});

				if (shouldScroll) {
					chatWindow.scrollTop = chatWindow.scrollHeight; // 滚动到底部
				}

				// 如果是首次加载
				if (isInitialLoad) {
					isInitialLoad = false; // 首次加载完成后，将标记设置为 false
				} else if (!isInitialLoad && newMessages.length > 0 && document.hidden && enableNotificationsCheckbox.checked) {
					// 只有当不是首次加载，且有新消息，且页面处于后台，并且用户开启了通知时才触发
					newMessages.forEach(msg => {
						showNotification(msg.username, msg.message);
					});
				}

			} catch (error) {
				console.error('获取消息失败:', error);
			}
		}

		// 显示通知
		function showNotification(username, messageContent) {
			if (Notification.permission === 'granted') {
				const title = username; // 通知标题是用户名
				const options = {
					body: messageContent, // 通知正文是消息内容
					icon: 'https://www.google.com/s2/favicons?domain=guguan.us.kg' // 网站图标
				};
				const notification = new Notification(title, options);
				currentNotifications.push(notification); // 存储通知实例
				// 在通知关闭时从列表中移除
				notification.onclose = () => {
					currentNotifications = currentNotifications.filter(n => n !== notification);
				};
			}
		}

		// 关闭所有当前活动的通知
		function closeAllNotifications() {
			currentNotifications.forEach(notification => {
				notification.close();
			});
			currentNotifications = []; // 清空数组
		}

		async function sendMessage() {
			const username = getCookie('username') || 'anonymous';
			if (username === 'anonymous') {
				alert('请先登录或注册一个昵称。');
				window.location.href = 'user_management.html';
				return;
			}
			
			let message = messageInput.value.trim();

			if (message === '') {
				alert('消息内容不能为空。');
				return;
			}

			messageInput.disabled = true;
			sendButton.disabled = true;
			sendButton.textContent = '发送中...';

			const messagesToSend = [];
			while (message.length > 0) {
				messagesToSend.push(message.substring(0, MAX_FRONTEND_MESSAGE_LENGTH));
				message = message.substring(MAX_FRONTEND_MESSAGE_LENGTH);
			}

			try {
				for (const part of messagesToSend) {
					const formData = new URLSearchParams();
					formData.append('message', part);

					const response = await fetch('./cgi-bin/chat_handler.cgi', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: formData.toString()
					});
					
					const result = await response.json();

					if (!response.ok) {
						throw new Error(result.message || `HTTP error! status: ${response.status}`);
					}
					console.log('消息发送结果:', result.message);
				}

				messageInput.value = '';
				fetchMessages();
			} catch (error) {
				console.error('发送消息失败:', error);
				alert('发送消息失败: ' + error.message);
			} finally {
				messageInput.disabled = false;
				sendButton.disabled = false;
				sendButton.textContent = '发送';
				messageInput.focus();
			}
		}

		function escapeHtml(str) {
			const div = document.createElement('div');
			div.appendChild(document.createTextNode(str));
			return div.innerHTML;
		}

		messageInput.addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				sendMessage();
			}
		});

		// 监听通知复选框的变化
		enableNotificationsCheckbox.addEventListener('change', function() {
			if (this.checked) {
				// 如果用户勾选了，请求通知权限
				if ('Notification' in window) {
					Notification.requestPermission().then(permission => {
						if (permission === 'granted') {
							localStorage.setItem('enableNotifications', 'true');
							console.log('通知权限已授予');
						} else {
							this.checked = false; // 如果用户拒绝，取消勾选
							localStorage.setItem('enableNotifications', 'false');
							alert('您已拒绝通知权限，无法接收新消息通知。');
						}
					});
				} else {
					alert('您的浏览器不支持桌面通知。');
					this.checked = false;
					localStorage.setItem('enableNotifications', 'false');
				}
			} else {
				// 如果用户取消勾选，则禁用通知
				localStorage.setItem('enableNotifications', 'false');
				console.log('新消息通知已禁用');
				closeAllNotifications(); // 用户关闭通知功能时，也尝试关闭已显示的通知
			}
		});

		// 页面可见性改变时
		document.addEventListener('visibilitychange', () => {
			if (!document.hidden) {
				// 页面从后台切换到前台时
				console.log('页面可见，清除通知');
				closeAllNotifications(); // 尝试关闭所有通过此页面创建的通知
			}
		});
	</script>
</body>
</html>
