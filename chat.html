<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>聊天室</title>
	<style>
		body {
			margin: 0; /* 将body的margin设置为0，以便更好地控制整体布局*/
			display: flex; /* 使用Flexbox布局*/
			flex-direction: column; /* 垂直方向排列子元素*/
			height: 100vh; /* 设置body高度为视口高度，确保聊天窗口能撑开*/
			padding: 20px; /* 页面内容与边缘的间距*/
			box-sizing: border-box; /* 边距和内边距包含在元素的总宽度和高度内*/
		}

		h1 {
			margin-top: 0; /* 移除标题的顶部外边距*/
			margin-bottom: 20px; /* 增加标题底部外边距*/
		}

		#username-input {
			margin-bottom: 10px; /* 用户名输入框的底部间距*/
		}

		/* 聊天窗口的核心样式：边框、内边距、溢出滚动，高度自适应*/
		#chat-window {
			border: 1px solid #ccc; /* 灰色边框*/
			padding: 10px; /* 内边距*/
			flex-grow: 1; /* 允许聊天窗口占据所有可用空间*/
			overflow-y: scroll; /* 垂直滚动条*/
			margin-bottom: 10px; /* 底部间距*/
			background-color: #fff; /* 白色背景，保持可读性*/
		}

		/* 聊天消息的间距*/
		.message {
			margin-bottom: 8px; /* 每条消息之间的间距*/
		}

		/* 时间戳样式：小字体和灰色，弱化显示*/
		.timestamp {
			font-size: 0.8em; /* 字体小一点*/
			color: #888; /* 灰色*/
			margin-left: 10px; /* 与消息内容的间距*/
		}

		/* 输入框和按钮：移除大部分样式，保留必要的宽度调整*/
		.input-form {
			display: flex; /* 使用Flexbox布局*/
			width: 100%; /* 宽度占满父容器*/
		}

		.input-form input[type="text"] {
			flex-grow: 1; /* 输入框占据所有可用空间*/
			padding: 8px; /* 内边距*/
			border: 1px solid #ccc; /* 边框*/
			margin-right: 10px; /* 与按钮的间距*/
		}

		.input-form button {
			padding: 8px 15px; /* 内边距*/
			background-color: #007bff; /* 蓝色背景*/
			color: white; /* 白色文字*/
			border: none; /* 无边框*/
			cursor: pointer; /* 鼠标指针样式*/
		}
	</style>
</head>
<body>
	<h1>聊天室</h1>

	<div id="username-input">
		<label for="username">你的名字:</label>
		<input type="text" id="username" placeholder="输入你的名字" value="anonymous">
	</div>

	<div id="chat-window">
		</div>

	<div class="input-form">
		<input type="text" id="message-input" placeholder="输入消息...">
		<button onclick="sendMessage()">发送</button>
	</div>

<script>
		const chatWindow = document.getElementById('chat-window');
		const messageInput = document.getElementById('message-input');
		const usernameInput = document.getElementById('username');
		const sendButton = document.querySelector('.input-form button'); // 获取发送按钮

		setInterval(fetchMessages, 5000); // 每5秒获取一次消息

		window.onload = fetchMessages; // 页面加载时获取一次消息

		async function fetchMessages() {
			try {
				const response = await fetch('./cgi-bin/get_messages.sh');
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const messages = await response.json();
				chatWindow.innerHTML = ''; // 清空聊天窗口
				messages.forEach(msg => {
					if (msg.timestamp && msg.ip && msg.username && msg.message) {
						const messageElement = document.createElement('div');
						messageElement.classList.add('message');
						messageElement.innerHTML = `<strong>${escapeHtml(msg.username)}</strong>: ${escapeHtml(msg.message)} <span class="timestamp">${msg.timestamp}</span>`;
						chatWindow.appendChild(messageElement);
					}
				});
				chatWindow.scrollTop = chatWindow.scrollHeight; // 滚动到底部
			} catch (error) {
				console.error('获取消息失败:', error);
			}
		}

		async function sendMessage() {
			const message = messageInput.value.trim();
			const username = usernameInput.value.trim() || 'anonymous';
			if (message === '') {
				return;
			}

			// 禁用输入框和发送按钮
			messageInput.disabled = true;
			sendButton.disabled = true;
			sendButton.textContent = '发送中...'; // 可以在按钮上显示加载状态

			const formData = new URLSearchParams();
			formData.append('username', username);
			formData.append('message', message);

			try {
				const response = await fetch('./cgi-bin/post_message.sh', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: formData.toString()
				});

				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const result = await response.text();
				console.log('消息发送结果:', result);
				messageInput.value = ''; // 清空输入框
				fetchMessages(); // 发送成功后刷新消息
			} catch (error) {
				console.error('发送消息失败:', error);
			} finally {
				// 无论成功或失败，最后都重新启用输入框和发送按钮
				messageInput.disabled = false;
				sendButton.disabled = false;
				sendButton.textContent = '发送'; // 恢复按钮文本
				messageInput.focus(); // 将焦点重新设置回输入框，方便用户继续输入
			}
		}

		function escapeHtml(str) {
			const div = document.createElement('div');
			div.appendChild(document.createTextNode(str));
			return div.innerHTML;
		}

		messageInput.addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				sendMessage();
			}
		});
	</script>
</body>
</html>
